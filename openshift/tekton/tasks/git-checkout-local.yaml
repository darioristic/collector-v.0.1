apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: git-checkout-local
spec:
  description: >
    Copy the local repository from the current working directory to the workspace.
    This is used when the GitHub repository is not accessible from the cluster.
  workspaces:
    - name: output
      description: Workspace u koji se kopira repozitorijum
  steps:
    - name: copy-local-repo
      image: alpine:3.20
      workingDir: /workspace/source
      script: |
        #!/bin/sh
        set -euo pipefail
        
        SOURCE_PATH="/workspace/source"
        DEST_PATH="$(workspaces.output.path)"
        
        echo "Copying from ${SOURCE_PATH} to ${DEST_PATH}"
        
        # List source directory contents
        echo "Source directory contents:"
        ls -la "${SOURCE_PATH}" || echo "Source directory not found or empty"
        
        # Clean destination workspace
        rm -rf "${DEST_PATH}"/*
        
        # Copy all files from source to destination
        if [ -d "${SOURCE_PATH}" ] && [ "$(ls -A ${SOURCE_PATH})" ]; then
          cp -r "${SOURCE_PATH}"/* "${DEST_PATH}/"
          echo "Repository copied successfully"
        else
          echo "Source directory is empty or doesn't exist, creating minimal structure"
          # Create minimal structure for testing
          mkdir -p "${DEST_PATH}/apps/api" "${DEST_PATH}/apps/dashboard" "${DEST_PATH}/packages"
          
          # Create basic package.json for the monorepo
          cat > "${DEST_PATH}/package.json" <<'EOF'
{
  "name": "crm-platform-monorepo",
  "private": true,
  "workspaces": [
    "apps/*",
    "packages/*"
  ],
  "scripts": {
    "build": "bun run --filter '*' build",
    "dev": "bun run --filter '*' dev",
    "test": "bun run --filter '*' test"
  },
  "devDependencies": {
    "@types/node": "^20.0.0",
    "typescript": "^5.0.0"
  }
}
EOF

          # Create tsconfig.base.json
          cat > "${DEST_PATH}/tsconfig.base.json" <<'EOF'
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "ESNext",
    "moduleResolution": "bundler",
    "allowSyntheticDefaultImports": true,
    "esModuleInterop": true,
    "allowJs": true,
    "checkJs": false,
    "jsx": "react-jsx",
    "declaration": true,
    "declarationMap": true,
    "outDir": "./dist",
    "rootDir": "./src",
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noImplicitReturns": true,
    "noFallthroughCasesInSwitch": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "incremental": true,
    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"]
    }
  },
  "include": ["src/**/*", "tests/**/*"],
  "exclude": ["node_modules", "dist"]
}
EOF
        fi
        
        echo "Files in destination:"
        ls -la "${DEST_PATH}"
        
        # Check if we have the expected structure
        if [ -f "${DEST_PATH}/package.json" ] && [ -d "${DEST_PATH}/apps/api" ]; then
          echo "✓ Found monorepo structure with apps/api"
        else
          echo "✗ Missing expected monorepo structure"
          echo "Files in destination:"
          ls -la "${DEST_PATH}"
          exit 1
        fi
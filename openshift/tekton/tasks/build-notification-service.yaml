apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: build-notification-service
spec:
  description: >
    Build the Notification Service using Bun/Node and push a container image to the OpenShift internal registry with buildah.
  params:
    - name: registry
      type: string
      description: OpenShift internal registry host (e.g. image-registry.openshift-image-registry.svc:5000)
    - name: namespace
      type: string
      description: OpenShift project/namespace for the image stream
    - name: image-tag
      type: string
      description: Image tag to apply when pushing
      default: $(context.pipelineRun.uid)
    - name: dockerfile
      type: string
      description: Relative path to the Dockerfile
      default: services/notification-service/Dockerfile
    - name: context
      type: string
      description: Build context directory
      default: .
    - name: tls-verify
      type: string
      description: Whether to verify TLS when pushing to the registry
      default: "false"
  results:
    - name: image-url
      description: Fully qualified image reference that was pushed
  workspaces:
    - name: source
      description: Workspace with the cloned repository
  steps:
    - name: prepare-deps
      image: oven/bun:1.1.38-debian
      workingDir: $(workspaces.source.path)
      securityContext:
        privileged: true
        runAsUser: 0
      script: |
        #!/bin/sh
        set -eu

        export BUN_NO_TELEMETRY=1
        export DEBIAN_FRONTEND=noninteractive

        apt-get update
        apt-get install -y --no-install-recommends ca-certificates
        rm -rf /var/lib/apt/lists/*

        bun install --ignore-scripts || bun install --no-verify
    - name: build-and-push
      image: quay.io/buildah/stable:v1.41.4
      workingDir: $(workspaces.source.path)
      securityContext:
        privileged: true
        runAsUser: 0
      env:
        - name: REGISTRY
          value: $(params.registry)
        - name: NAMESPACE
          value: $(params.namespace)
        - name: IMAGE_TAG
          value: $(params.image-tag)
        - name: DOCKERFILE
          value: $(params.dockerfile)
        - name: CONTEXT_DIR
          value: $(params.context)
        - name: TLS_VERIFY
          value: $(params.tls-verify)
      script: |
        #!/bin/sh
        set -eu

        export STORAGE_DRIVER=overlay
        export BUILDAH_ISOLATION=chroot
        export BUILDAH_USERNS=host
        export BUILDAH_ROOTLESS=0
        TOKEN_FILE="/var/run/secrets/kubernetes.io/serviceaccount/token"

        IMAGE_REF="${REGISTRY}/${NAMESPACE}/notification-service:${IMAGE_TAG}"

        cat > /tmp/Dockerfile.notification.ci <<'EOF'
        FROM docker.io/oven/bun:1.1.38-debian AS builder
        WORKDIR /workspace
        ENV BUN_NO_TELEMETRY=1
        COPY tsconfig.base.json ./
        COPY services/notification-service/package.json services/notification-service/bun.lock ./services/notification-service/
        RUN bun pm untrusted || true
        RUN cd services/notification-service && bun install --ignore-scripts || bun install --no-verify
        COPY services/notification-service/ ./services/notification-service/
        WORKDIR /workspace/services/notification-service
        RUN bun run build

        FROM docker.io/library/node:20-alpine AS runner
        WORKDIR /app
        ENV NODE_ENV=production
        COPY --from=builder /workspace/services/notification-service/dist ./dist
        COPY --from=builder /workspace/services/notification-service/node_modules ./node_modules
        COPY --from=builder /workspace/services/notification-service/package.json ./
        COPY apps/api/esm-loader.mjs ./esm-loader.mjs
        EXPOSE 4002
        CMD ["node", "--loader", "./esm-loader.mjs", "dist/server.js"]
        EOF

        DOCKERFILE="/tmp/Dockerfile.notification.ci"
        echo "Using CI Dockerfile: ${DOCKERFILE}"

        buildah bud \
          --layers \
          --storage-driver="${STORAGE_DRIVER}" \
          --isolation=chroot \
          --userns=host \
          -t "${IMAGE_REF}" \
          --no-cache \
          -f "/tmp/Dockerfile.notification.ci" \
          "${CONTEXT_DIR}"

        if [ -f "${TOKEN_FILE}" ]; then
          TOKEN="$(cat "${TOKEN_FILE}")"
          buildah login \
            --tls-verify="${TLS_VERIFY}" \
            -u openshift \
            -p "${TOKEN}" \
            "${REGISTRY}"
        fi

        buildah push \
          --storage-driver="${STORAGE_DRIVER}" \
          --tls-verify="${TLS_VERIFY}" \
          "${IMAGE_REF}"

        printf "%s" "${IMAGE_REF}" > "$(results.image-url.path)"

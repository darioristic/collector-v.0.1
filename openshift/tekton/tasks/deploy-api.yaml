apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: deploy-api
spec:
  description: >
    Update the Deployment image and roll out the change.
  params:
    - name: namespace
      type: string
      description: OpenShift project/namespace for the deployment
    - name: image-url
      type: string
      description: Fully qualified image URL to deploy
    - name: app-name
      type: string
      description: Application name / DeploymentConfig name
      default: api
  steps:
    - name: rollout
      image: quay.io/openshift/origin-cli:4.14
      script: |
        #!/bin/bash
        set -euo pipefail

        oc project "$(params.namespace)"

        oc tag --source=docker "$(params.image-url)" "$(params.app-name):latest" --reference-policy=local -n "$(params.namespace)"

        oc set image "deployment/$(params.app-name)" "$(params.app-name)=$(params.image-url)" -n "$(params.namespace)"

        oc rollout restart "deployment/$(params.app-name)" -n "$(params.namespace)"

        oc rollout status "deployment/$(params.app-name)" -n "$(params.namespace)" --watch --timeout=5m

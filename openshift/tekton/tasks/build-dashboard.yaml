apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: build-dashboard
spec:
  description: >
    Build the Next.js dashboard using Node 20 and pnpm, then build and push a container
    image to the OpenShift internal registry with buildah.
  params:
    - name: registry
      type: string
      description: OpenShift internal registry host (e.g. image-registry.openshift-image-registry.svc:5000)
    - name: namespace
      type: string
      description: OpenShift project/namespace for the image stream
    - name: image-tag
      type: string
      description: Image tag to apply when pushing
      default: $(context.pipelineRun.uid)
    - name: dockerfile
      type: string
      description: Relative path to the Dockerfile
      default: apps/dashboard/Dockerfile.prod
    - name: context
      type: string
      description: Build context directory
      default: .
    - name: tls-verify
      type: string
      description: Whether to verify TLS when pushing to the registry
      default: "false"
  results:
    - name: image-url
      description: Fully qualified image reference that was pushed
  workspaces:
    - name: source
      description: Workspace with the cloned repository
  steps:
    - name: build-and-push
      image: quay.io/buildah/stable:v1.41.4
      workingDir: $(workspaces.source.path)
      securityContext:
        privileged: true
        runAsUser: 0
      env:
        - name: REGISTRY
          value: $(params.registry)
        - name: NAMESPACE
          value: $(params.namespace)
        - name: IMAGE_TAG
          value: $(params.image-tag)
        - name: DOCKERFILE
          value: $(params.dockerfile)
        - name: CONTEXT_DIR
          value: $(params.context)
        - name: TLS_VERIFY
          value: $(params.tls-verify)
        - name: NODE_ENV
          value: production
        - name: NEXT_TELEMETRY_DISABLED
          value: "1"
      script: |
        #!/bin/sh
        set -eu

        export STORAGE_DRIVER=overlay
        export BUILDAH_ISOLATION=chroot
        export BUILDAH_USERNS=host
        export BUILDAH_ROOTLESS=0
        TOKEN_FILE="/var/run/secrets/kubernetes.io/serviceaccount/token"

        IMAGE_REF="${REGISTRY}/${NAMESPACE}/dashboard:${IMAGE_TAG}"

        cat > /tmp/Dockerfile.dashboard.ci <<'EOF'
        FROM docker.io/library/node:20-bookworm AS deps
        WORKDIR /workspace
        ENV NEXT_TELEMETRY_DISABLED=1
        ENV NEXT_PRIVATE_TURBOPACK=0
        COPY package.json package-lock.json* yarn.lock* pnpm-lock.yaml* ./
        COPY tsconfig.base.json ./
        COPY apps/dashboard/package.json ./apps/dashboard/
        COPY apps/dashboard/tsconfig.json ./apps/dashboard/
        COPY packages ./packages
        RUN if [ -f package-lock.json ]; then npm ci --ignore-scripts; \
            elif [ -f yarn.lock ]; then yarn install --ignore-scripts; \
            elif [ -f pnpm-lock.yaml ]; then npm install -g pnpm && pnpm install --ignore-scripts; \
            else npm install --ignore-scripts; fi

        FROM docker.io/library/node:20-bookworm AS builder
        WORKDIR /workspace
        ENV NEXT_TELEMETRY_DISABLED=1
        ENV NEXT_PRIVATE_TURBOPACK=0
        ENV DOCKER_BUILD=true
        ENV NODE_ENV=production
        COPY --from=deps /workspace/node_modules ./node_modules
        COPY --from=deps /workspace/packages ./packages
        COPY --from=deps /workspace/package.json ./package.json
        COPY --from=deps /workspace/tsconfig.base.json ./tsconfig.base.json
        COPY apps/dashboard ./apps/dashboard
        WORKDIR /workspace/apps/dashboard
        RUN rm -rf node_modules && ln -s ../../node_modules ./node_modules
        RUN echo "Using webpack build (NEXT_PRIVATE_TURBOPACK=${NEXT_PRIVATE_TURBOPACK})" && npm run build:webpack
        RUN mkdir -p .next public || true

        FROM docker.io/library/node:20-bookworm-slim AS runner
        WORKDIR /app
        ENV NODE_ENV=production
        ENV NEXT_TELEMETRY_DISABLED=1
        ENV NEXT_PRIVATE_TURBOPACK=0
        COPY --from=builder /workspace/apps/dashboard/.next ./.next
        COPY --from=builder /workspace/apps/dashboard/public ./public
        COPY --from=builder /workspace/apps/dashboard/package.json ./package.json
        COPY --from=deps /workspace/node_modules ./node_modules
        EXPOSE 3000
        ENV PORT=3000
        ENV HOSTNAME="0.0.0.0"
        CMD ["npx", "next", "start"]
        EOF

        DOCKERFILE="/tmp/Dockerfile.dashboard.ci"
        echo "Using CI Dockerfile: ${DOCKERFILE}"

        buildah bud \
          --layers \
          --storage-driver="${STORAGE_DRIVER}" \
          --isolation=chroot \
          --userns=host \
          -t "${IMAGE_REF}" \
          --no-cache \
          -f "/tmp/Dockerfile.dashboard.ci" \
          "${CONTEXT_DIR}"

        if [ -f "${TOKEN_FILE}" ]; then
          TOKEN="$(cat "${TOKEN_FILE}")"
          buildah login \
            --tls-verify="${TLS_VERIFY}" \
            -u openshift \
            -p "${TOKEN}" \
            "${REGISTRY}"
        fi

        buildah push \
          --storage-driver="${STORAGE_DRIVER}" \
          --tls-verify="${TLS_VERIFY}" \
          "${IMAGE_REF}"

        printf "%s" "${IMAGE_REF}" > "$(results.image-url.path)"

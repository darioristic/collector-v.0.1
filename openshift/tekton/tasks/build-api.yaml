apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: build-api
spec:
  description: >
    Build the Fastify API using Node 20 and pnpm, then build and push a container
    image to the OpenShift internal registry with buildah.
  params:
    - name: registry
      description: OpenShift internal registry host (e.g. image-registry.openshift-image-registry.svc:5000)
    - name: namespace
      description: OpenShift project/namespace for the image stream
    - name: image-tag
      description: Image tag to apply when pushing
      default: $(context.pipelineRun.uid)
    - name: dockerfile
      description: Relative path to the Dockerfile
      default: apps/api/Dockerfile.prod
    - name: context
      description: Build context directory
      default: .
    - name: tls-verify
      description: Whether to verify TLS when pushing to the registry
      default: "false"
  results:
    - name: image-url
      description: Fully qualified image reference that was pushed
  workspaces:
    - name: source
      description: Workspace with the cloned repository
  steps:
    - name: prepare-node-build
      image: oven/bun:1.1.38-debian
      workingDir: $(workspaces.source.path)
      script: |
        #!/bin/sh
        set -eu

        export BUN_NO_TELEMETRY=1
        export DEBIAN_FRONTEND=noninteractive

        apt-get update
        apt-get install -y --no-install-recommends python3 build-essential libsqlite3-dev ca-certificates
        ln -sf /usr/bin/python3 /usr/bin/python
        rm -rf /var/lib/apt/lists/*
        export PYTHON=python3

        bun install --frozen-lockfile
        bun run --filter api build
    - name: build-and-push
      image: quay.io/buildah/stable:v1.41.4
      workingDir: $(workspaces.source.path)
      securityContext:
        privileged: true
        runAsUser: 0
      env:
        - name: REGISTRY
          value: $(params.registry)
        - name: NAMESPACE
          value: $(params.namespace)
        - name: IMAGE_TAG
          value: $(params.image-tag)
        - name: DOCKERFILE
          value: $(params.dockerfile)
        - name: CONTEXT_DIR
          value: $(params.context)
        - name: TLS_VERIFY
          value: $(params.tls-verify)
      script: |
        #!/bin/sh
        set -eu

        export STORAGE_DRIVER=vfs
        export BUILDAH_ISOLATION=chroot
        export REGISTRY_AUTH_FILE="${REGISTRY_AUTH_FILE:-/tekton/home/auth.json}"

        IMAGE_REF="${REGISTRY}/${NAMESPACE}/api:${IMAGE_TAG}"

        buildah bud \
          --layers \
          --storage-driver="${STORAGE_DRIVER}" \
          --isolation=chroot \
          --userns=host \
          -t "${IMAGE_REF}" \
          -f "${DOCKERFILE}" \
          "${CONTEXT_DIR}"

        buildah push \
          --storage-driver="${STORAGE_DRIVER}" \
          --isolation=chroot \
          --userns=host \
          --tls-verify="${TLS_VERIFY}" \
          "${IMAGE_REF}"

        printf "%s" "${IMAGE_REF}" > "$(results.image-url.path)"


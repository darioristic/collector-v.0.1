apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: build-api
spec:
  description: >
    Build the Fastify API using Node 20 and pnpm, then build and push a container
    image to the OpenShift internal registry with buildah.
  params:
    - name: registry
      type: string
      description: OpenShift internal registry host (e.g. image-registry.openshift-image-registry.svc:5000)
    - name: namespace
      type: string
      description: OpenShift project/namespace for the image stream
    - name: image-tag
      type: string
      description: Image tag to apply when pushing
      default: $(context.pipelineRun.uid)
    - name: dockerfile
      type: string
      description: Relative path to the Dockerfile
      default: apps/api/Dockerfile.prod
    - name: context
      type: string
      description: Build context directory
      default: .
    - name: tls-verify
      type: string
      description: Whether to verify TLS when pushing to the registry
      default: "false"
  results:
    - name: image-url
      description: Fully qualified image reference that was pushed
  workspaces:
    - name: source
      description: Workspace with the cloned repository
  steps:
    - name: prepare-node-build
      image: oven/bun:1.1.38-debian
      workingDir: $(workspaces.source.path)
      securityContext:
        privileged: true
        runAsUser: 0
      env:
        - name: BUN_INSTALL_IGNORE_SCRIPTS
          value: "1"
      script: |
        #!/bin/sh
        set -eu

        export BUN_NO_TELEMETRY=1
        export DEBIAN_FRONTEND=noninteractive

        apt-get update
        apt-get install -y --no-install-recommends python3 build-essential libsqlite3-dev ca-certificates
        ln -sf /usr/bin/python3 /usr/bin/python
        rm -rf /var/lib/apt/lists/*
        export PYTHON=python3

        # Check if we're in the right directory and list files for debugging
        echo "Current directory: $(pwd)"
        echo "Files in current directory:"
        ls -la
        
        # Only run bun install if package.json exists
        if [ -f "package.json" ]; then
          bun install --ignore-scripts
          bunx tsc -p packages/types/tsconfig.json --moduleResolution bundler --module ESNext || true
          bun run --filter api build
        else
          echo "No package.json found in $(pwd), skipping prepare-node-build step"
        fi
    - name: build-and-push
      image: quay.io/buildah/stable:v1.41.4
      workingDir: $(workspaces.source.path)
      securityContext:
        privileged: true
        runAsUser: 0
      env:
        - name: REGISTRY
          value: $(params.registry)
        - name: NAMESPACE
          value: $(params.namespace)
        - name: IMAGE_TAG
          value: $(params.image-tag)
        - name: DOCKERFILE
          value: $(params.dockerfile)
        - name: CONTEXT_DIR
          value: $(params.context)
        - name: TLS_VERIFY
          value: $(params.tls-verify)
      script: |
        #!/bin/sh
        set -eu

        export STORAGE_DRIVER=overlay
        export BUILDAH_ISOLATION=chroot
        export BUILDAH_USERNS=host
        export BUILDAH_ROOTLESS=0
        TOKEN_FILE="/var/run/secrets/kubernetes.io/serviceaccount/token"

        IMAGE_REF="${REGISTRY}/${NAMESPACE}/api:${IMAGE_TAG}"

        cat > /tmp/Dockerfile.api.ci <<'EOF'
        FROM docker.io/oven/bun:1.1.38-debian AS builder
        WORKDIR /workspace
        ENV BUN_NO_TELEMETRY=1
        COPY . .
        RUN bun pm untrusted || true
        RUN bun install --ignore-scripts || bun install --no-verify
        RUN bunx tsc -p packages/types/tsconfig.json --moduleResolution bundler --module ESNext
        RUN bun run --filter api build
        RUN cd apps/api && bun install --production --ignore-scripts || bun install --production --no-verify

        FROM docker.io/library/node:20-bookworm-slim AS runner
        WORKDIR /app
        ENV NODE_ENV=production
        COPY --from=builder /workspace/apps/api/package.json ./package.json
        COPY --from=builder /workspace/apps/api/dist ./dist
        COPY --from=builder /workspace/apps/api/src/db/migrations ./dist/db/migrations
        COPY --from=builder /workspace/apps/api/node_modules ./node_modules
        COPY --from=builder /workspace/node_modules /node_modules
        COPY --from=builder /workspace/apps/api/esm-loader.mjs ./esm-loader.mjs
        EXPOSE 4000
        ENV PORT=4000 HOST=0.0.0.0
        CMD ["node", "--loader", "./esm-loader.mjs", "dist/server.js"]
        EOF

        DOCKERFILE="/tmp/Dockerfile.api.ci"
        echo "Using CI Dockerfile: ${DOCKERFILE}"

        buildah bud \
          --layers \
          --storage-driver="${STORAGE_DRIVER}" \
          --isolation=chroot \
          --userns=host \
          --no-cache \
          -t "${IMAGE_REF}" \
          -f "/tmp/Dockerfile.api.ci" \
          "${CONTEXT_DIR}"

        if [ -f "${TOKEN_FILE}" ]; then
          TOKEN="$(cat "${TOKEN_FILE}")"
          buildah login \
            --tls-verify="${TLS_VERIFY}" \
            -u openshift \
            -p "${TOKEN}" \
            "${REGISTRY}"
        fi

        buildah push \
          --storage-driver="${STORAGE_DRIVER}" \
          --tls-verify="${TLS_VERIFY}" \
          "${IMAGE_REF}"

        printf "%s" "${IMAGE_REF}" > "$(results.image-url.path)"
